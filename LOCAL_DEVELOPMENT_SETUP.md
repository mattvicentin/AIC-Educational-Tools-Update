# Local Development Environment Setup Guide

This guide will help you set up a local development environment for AI Collab Online.

## Prerequisites

- **Python 3.8+** (Python 3.9.6+ recommended)
- **pip** (Python package manager)
- **Git** (for cloning the repository)

## Quick Setup (Automated)

Run the automated setup script:

```bash
./setup_local_dev.sh
```

This script will:
1. ‚úÖ Check Python version
2. ‚úÖ Create/update virtual environment
3. ‚úÖ Install all dependencies
4. ‚úÖ Create instance directory for SQLite database
5. ‚úÖ Set up `.env` file from template
6. ‚úÖ Generate SECRET_KEY
7. ‚úÖ Initialize database tables
8. ‚úÖ Run Alembic migrations

## Manual Setup

If you prefer to set up manually or the script fails:

### 1. Create Virtual Environment

```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### 2. Install Dependencies

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### 3. Create Instance Directory

```bash
mkdir -p instance
```

This directory will store the SQLite database file (`ai_collab.db`).

### 4. Configure Environment Variables

```bash
cp env_template.txt .env
```

Edit `.env` and configure the following **required** variables:

```env
# Required: Flask Secret Key (auto-generated by setup script)
SECRET_KEY=your_generated_secret_key_here

# Required: AI Service API Key
ANTHROPIC_API_KEY=sk-ant-your-key-here

# Optional: Flask Environment (defaults to development)
FLASK_ENV=development

# Optional: Database URL (defaults to SQLite for local dev)
# DATABASE_URL=sqlite:///instance/ai_collab.db
```

**Generate SECRET_KEY:**
```bash
python3 -c "import secrets; print(secrets.token_hex(32))"
```

**Get Anthropic API Key:**
1. Visit https://console.anthropic.com/
2. Sign up or log in
3. Navigate to API Keys section
4. Create a new API key
5. Copy and paste into `.env`

### 5. Initialize Database

```bash
# Activate virtual environment first
source venv/bin/activate

# Initialize database tables
python3 -c "
from src.main import app
from src.app import db
with app.app_context():
    db.create_all()
    print('Database initialized')
"
```

### 6. Run Migrations

```bash
alembic upgrade head
```

## Running the Application

### Start Development Server

```bash
# Activate virtual environment
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Run the application
python run.py
```

The application will start on **http://localhost:5001** (or port specified in `PORT` env var).

### Verify Installation

1. **Health Check**: http://localhost:5001/health
   - Should return: `{"status": "alive", "timestamp": "..."}`

2. **Readiness Check**: http://localhost:5001/ready
   - Should return: `{"status": "ready", "checks": {...}}`

3. **Home Page**: http://localhost:5001/
   - Should redirect to room list or login page

## Development Workflow

### Activating Virtual Environment

Always activate the virtual environment before working:

```bash
source venv/bin/activate  # macOS/Linux
# or
venv\Scripts\activate     # Windows
```

### Database Management

**View database:**
```bash
# SQLite database location
ls -lh instance/ai_collab.db
```

**Reset database (‚ö†Ô∏è deletes all data):**
```bash
rm instance/ai_collab.db
python3 -c "from src.main import app; from src.app import db; app.app_context().push(); db.create_all()"
alembic upgrade head
```

**Create new migration:**
```bash
alembic revision --autogenerate -m "description of changes"
alembic upgrade head
```

### Running Tests

```bash
# Run all tests
python -m pytest

# Run specific test file
python -m pytest tests/test_chat.py

# Run with coverage
python -m pytest --cov=src tests/
```

### Code Quality Checks

```bash
# Type checking
python -m mypy src/app/ --ignore-missing-imports

# Linting
python -m flake8 src/ --max-line-length=120
```

## Troubleshooting

### Common Issues

#### 1. **ModuleNotFoundError: No module named 'src'**

**Solution:** Ensure you're running commands from the project root directory and have activated the virtual environment.

```bash
cd /path/to/Collab_AI_Online-feature-railway-deployment
source venv/bin/activate
```

#### 2. **Database locked (SQLite)**

**Solution:** Close any database viewers or other processes accessing the database.

```bash
# Find processes using the database
lsof instance/ai_collab.db  # macOS/Linux
```

#### 3. **Port already in use**

**Solution:** Change the port or kill the process using it:

```bash
# Find process using port 5001
lsof -ti:5001  # macOS/Linux
netstat -ano | findstr :5001  # Windows

# Kill process (replace PID)
kill -9 <PID>
```

Or set a different port:
```bash
export PORT=5002
python run.py
```

#### 4. **Migration errors**

**Solution:** The app has manual fallbacks in `src/main.py`. If migrations fail, tables will be created automatically. Check logs for details.

#### 5. **Missing API Key**

**Solution:** Ensure `.env` file exists and contains `ANTHROPIC_API_KEY`. The app will show helpful error messages if the key is missing.

#### 6. **Template folder not found**

**Solution:** Ensure you're using lowercase `templates/` directory (not `Templates/`). This is important on macOS which has case-insensitive filesystem by default.

```bash
# Verify templates directory exists
ls -d templates/
```

### Getting Help

- Check application logs in terminal output
- Visit `/health` and `/ready` endpoints for diagnostics
- Check `.env` file configuration
- Verify virtual environment is activated
- Ensure all dependencies are installed: `pip list`

## Environment Variables Reference

### Required

| Variable | Description | Example |
|----------|-------------|---------|
| `SECRET_KEY` | Flask secret key for sessions | Auto-generated 64-char hex |
| `ANTHROPIC_API_KEY` | Anthropic Claude API key | `sk-ant-...` |

### Optional

| Variable | Description | Default |
|----------|-------------|---------|
| `FLASK_ENV` | Flask environment | `development` |
| `DATABASE_URL` | Database connection string | `sqlite:///instance/ai_collab.db` |
| `PORT` | Server port | `5001` |
| `ANTHROPIC_MODEL` | Claude model to use | `claude-3-5-sonnet-20241022` |
| `AI_MAX_TOKENS` | Max tokens per AI response | `400` |
| `AI_MAX_HISTORY` | Conversation turns to include | `8` |

### Feature Flags

| Variable | Description | Default |
|----------|-------------|---------|
| `REFINE_V2_ENABLED` | Enable new refinement flow | `false` |
| `ENABLE_ARCHETYPE_PROMPTS` | Enable adaptive AI expression | `true` |
| `ROOM_MAX_CHATS` | Max chats per room | `25` |

## Next Steps

Once your local environment is set up:

1. ‚úÖ Create a test user account
2. ‚úÖ Create a test room
3. ‚úÖ Test chat functionality
4. ‚úÖ Test AI responses
5. ‚úÖ Explore the learning progression features
6. ‚úÖ Test pin functionality

Happy coding! üöÄ

